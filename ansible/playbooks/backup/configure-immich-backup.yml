---
# Immich Application-Level Backup Configuration
# Configures automated PostgreSQL database dumps for Immich
#
# Usage: ansible-playbook backup/configure-immich-backup.yml -v
#
# What this playbook does:
# 1. Creates backup script for PostgreSQL database dumps
# 2. Sets up cron job to run at 02:30 daily (before PBS backup at 03:00)
# 3. Stores dumps on NFS share for additional redundancy
# 4. Maintains 7 days of backup retention
#
# Why application-level backup?
# - Faster restore than VM-level (minutes vs. hours)
# - Can restore to different Immich version
# - Portable across different infrastructure
# - More granular recovery options

- name: Configure Immich Application-Level Backup
  hosts: immich-vm01
  become: yes

  vars:
    # Immich directories
    immich_local_dir: "/opt/immich"
    immich_uploads_mount: "/mnt/immich-uploads"

    # Backup configuration
    backup_dir: "{{ immich_uploads_mount }}/db-backups"
    backup_retention_days: 7

    # Cron schedule (02:30 - 30 minutes before PBS backup at 03:00)
    backup_cron_hour: "2"
    backup_cron_minute: "30"

    # PostgreSQL container name
    postgres_container: "immich-postgres"
    postgres_user: "postgres"

  tasks:
    # ============================================
    # PREREQUISITES CHECK
    # ============================================

    - name: Verify Immich uploads mount is available
      stat:
        path: "{{ immich_uploads_mount }}"
      register: uploads_mount
      failed_when: not uploads_mount.stat.exists

    - name: Verify PostgreSQL container is running
      command: docker ps --filter "name={{ postgres_container }}" --format "{{ '{{' }}.Names{{ '}}' }}"
      register: postgres_check
      changed_when: false
      failed_when: postgres_container not in postgres_check.stdout

    # ============================================
    # CREATE BACKUP INFRASTRUCTURE
    # ============================================

    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    # ============================================
    # BACKUP SCRIPT
    # ============================================

    - name: Deploy Immich database backup script
      copy:
        dest: "{{ immich_local_dir }}/backup-db.sh"
        mode: "0755"
        content: |
          #!/bin/bash
          #
          # Immich PostgreSQL Backup Script
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          #
          # This script creates a full PostgreSQL dump of the Immich database
          # and stores it on the NFS share for redundancy.
          #
          # Backup location: {{ backup_dir }}
          # Retention: {{ backup_retention_days }} days
          #

          set -e

          # Configuration
          BACKUP_DIR="{{ backup_dir }}"
          RETENTION_DAYS={{ backup_retention_days }}
          POSTGRES_CONTAINER="{{ postgres_container }}"
          POSTGRES_USER="{{ postgres_user }}"
          LOG_FILE="/var/log/immich-backup.log"
          LOCK_FILE="/var/run/immich-backup.lock"

          # Timestamp for backup file
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_FILE="${BACKUP_DIR}/immich-db-${TIMESTAMP}.sql.gz"

          # Logging function
          log() {
              echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
          }

          # Check for existing lock
          if [ -f "$LOCK_FILE" ]; then
              log "ERROR: Backup already running (lock file exists)"
              exit 1
          fi

          # Create lock file and ensure cleanup
          trap "rm -f $LOCK_FILE" EXIT
          touch "$LOCK_FILE"

          log "========================================"
          log "Starting Immich database backup"
          log "========================================"

          # Verify backup directory exists
          if [ ! -d "$BACKUP_DIR" ]; then
              log "ERROR: Backup directory does not exist: $BACKUP_DIR"
              exit 1
          fi

          # Verify PostgreSQL container is running
          if ! docker ps --format '{{ '{{' }}.Names{{ '}}' }}' | grep -q "$POSTGRES_CONTAINER"; then
              log "ERROR: PostgreSQL container not running: $POSTGRES_CONTAINER"
              exit 1
          fi

          # Perform database dump
          log "Dumping PostgreSQL database..."
          if docker exec "$POSTGRES_CONTAINER" pg_dumpall -U "$POSTGRES_USER" | gzip > "$BACKUP_FILE"; then
              BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
              log "Database dump successful: $BACKUP_FILE ($BACKUP_SIZE)"
          else
              log "ERROR: Database dump failed"
              rm -f "$BACKUP_FILE"
              exit 1
          fi

          # Verify backup file
          if [ ! -s "$BACKUP_FILE" ]; then
              log "ERROR: Backup file is empty"
              rm -f "$BACKUP_FILE"
              exit 1
          fi

          # Cleanup old backups
          log "Cleaning up backups older than $RETENTION_DAYS days..."
          OLD_COUNT=$(find "$BACKUP_DIR" -name "immich-db-*.sql.gz" -mtime +$RETENTION_DAYS | wc -l)
          find "$BACKUP_DIR" -name "immich-db-*.sql.gz" -mtime +$RETENTION_DAYS -delete
          log "Removed $OLD_COUNT old backup(s)"

          # Count remaining backups
          BACKUP_COUNT=$(find "$BACKUP_DIR" -name "immich-db-*.sql.gz" | wc -l)
          TOTAL_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)

          log "========================================"
          log "Backup completed successfully"
          log "Backup file: $BACKUP_FILE"
          log "File size: $BACKUP_SIZE"
          log "Total backups: $BACKUP_COUNT"
          log "Total backup size: $TOTAL_SIZE"
          log "========================================"

    # ============================================
    # RESTORE SCRIPT
    # ============================================

    - name: Deploy Immich database restore script
      copy:
        dest: "{{ immich_local_dir }}/restore-db.sh"
        mode: "0755"
        content: |
          #!/bin/bash
          #
          # Immich PostgreSQL Restore Script
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          #
          # Usage: ./restore-db.sh [backup_file.sql.gz]
          #
          # If no file specified, lists available backups
          #

          set -e

          # Configuration
          BACKUP_DIR="{{ backup_dir }}"
          POSTGRES_CONTAINER="{{ postgres_container }}"
          POSTGRES_USER="{{ postgres_user }}"
          DB_NAME="immich"

          # Colors for output
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          NC='\033[0m' # No Color

          log() {
              echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
          }

          error() {
              echo -e "${RED}[ERROR]${NC} $1"
          }

          warn() {
              echo -e "${YELLOW}[WARNING]${NC} $1"
          }

          # List available backups if no argument
          if [ $# -eq 0 ]; then
              echo ""
              echo "Available Immich database backups:"
              echo "=================================="
              echo ""

              if [ ! -d "$BACKUP_DIR" ]; then
                  error "Backup directory not found: $BACKUP_DIR"
                  exit 1
              fi

              BACKUPS=$(ls -1t "$BACKUP_DIR"/immich-db-*.sql.gz 2>/dev/null || true)

              if [ -z "$BACKUPS" ]; then
                  warn "No backups found in $BACKUP_DIR"
                  exit 0
              fi

              echo "File                                    Size       Date"
              echo "----                                    ----       ----"

              for f in $BACKUPS; do
                  SIZE=$(du -h "$f" | cut -f1)
                  DATE=$(stat -c %y "$f" | cut -d. -f1)
                  BASENAME=$(basename "$f")
                  printf "%-40s %-10s %s\n" "$BASENAME" "$SIZE" "$DATE"
              done

              echo ""
              echo "Usage: $0 <backup_file.sql.gz>"
              echo ""
              echo "Example:"
              echo "  $0 ${BACKUP_DIR}/immich-db-20260114_023000.sql.gz"
              echo ""
              exit 0
          fi

          BACKUP_FILE="$1"

          # If just filename provided, prepend backup directory
          if [[ "$BACKUP_FILE" != /* ]]; then
              BACKUP_FILE="${BACKUP_DIR}/${BACKUP_FILE}"
          fi

          # Verify backup file exists
          if [ ! -f "$BACKUP_FILE" ]; then
              error "Backup file not found: $BACKUP_FILE"
              exit 1
          fi

          log "Starting Immich database restore"
          log "Backup file: $BACKUP_FILE"
          echo ""

          # Warning prompt
          warn "This will REPLACE the current Immich database!"
          warn "All current data will be LOST!"
          echo ""
          read -p "Are you sure you want to continue? (yes/no): " CONFIRM

          if [ "$CONFIRM" != "yes" ]; then
              log "Restore cancelled"
              exit 0
          fi

          echo ""
          log "Stopping Immich services..."
          cd {{ immich_local_dir }}
          docker compose stop immich-server immich-machine-learning

          log "Restoring database..."
          # Drop and recreate database
          docker exec "$POSTGRES_CONTAINER" psql -U "$POSTGRES_USER" -c "DROP DATABASE IF EXISTS $DB_NAME;"
          docker exec "$POSTGRES_CONTAINER" psql -U "$POSTGRES_USER" -c "CREATE DATABASE $DB_NAME;"

          # Restore from backup
          gunzip -c "$BACKUP_FILE" | docker exec -i "$POSTGRES_CONTAINER" psql -U "$POSTGRES_USER"

          log "Restarting Immich services..."
          docker compose start immich-server immich-machine-learning

          log "Waiting for services to start..."
          sleep 30

          # Verify services are running
          if docker compose ps | grep -q "Up"; then
              log "========================================"
              log "Restore completed successfully!"
              log "========================================"
              log ""
              log "Immich should be accessible at:"
              log "  http://{{ ansible_host }}:2283"
              log ""
              log "Please verify your photos and settings."
          else
              error "Services may not have started correctly"
              error "Check: docker compose ps"
              exit 1
          fi

    # ============================================
    # CRON JOB
    # ============================================

    - name: Configure backup cron job
      cron:
        name: "Immich database backup"
        minute: "{{ backup_cron_minute }}"
        hour: "{{ backup_cron_hour }}"
        job: "{{ immich_local_dir }}/backup-db.sh >> /var/log/immich-backup.log 2>&1"
        user: root
        state: present

    # ============================================
    # INITIAL BACKUP
    # ============================================

    - name: Run initial backup
      command: "{{ immich_local_dir }}/backup-db.sh"
      register: initial_backup
      changed_when: "'Backup completed successfully' in initial_backup.stdout"

    - name: Display initial backup result
      debug:
        msg: "{{ initial_backup.stdout_lines }}"

    # ============================================
    # VERIFICATION
    # ============================================

    - name: List backup files
      find:
        paths: "{{ backup_dir }}"
        patterns: "immich-db-*.sql.gz"
      register: backup_files

    - name: Display backup summary
      debug:
        msg: |
          ============================================
          IMMICH BACKUP CONFIGURATION COMPLETE
          ============================================

          Backup Schedule:
            Time: {{ backup_cron_hour }}:{{ backup_cron_minute }} daily
            Location: {{ backup_dir }}
            Retention: {{ backup_retention_days }} days

          Current Backups: {{ backup_files.files | length }}

          Scripts Created:
            Backup:  {{ immich_local_dir }}/backup-db.sh
            Restore: {{ immich_local_dir }}/restore-db.sh

          Manual Commands:
            # Run backup manually
            {{ immich_local_dir }}/backup-db.sh

            # List available backups
            {{ immich_local_dir }}/restore-db.sh

            # Restore from backup
            {{ immich_local_dir }}/restore-db.sh <backup-file.sql.gz>

            # View backup log
            tail -50 /var/log/immich-backup.log

          ============================================
