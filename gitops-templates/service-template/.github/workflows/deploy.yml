# GitOps Deployment Workflow
# Automatically deploys service when changes are pushed to main branch
# Uses self-hosted runners on the homelab infrastructure

name: Deploy Service

on:
  push:
    branches: [main]
    paths:
      - 'config/**'
      - 'service.yml'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        type: boolean
        default: false

env:
  DOMAIN: hrmsmrflrii.xyz

jobs:
  # ===========================================
  # JOB 1: Parse service configuration
  # ===========================================
  parse-config:
    name: Parse Configuration
    runs-on: ubuntu-latest
    outputs:
      service_name: ${{ steps.config.outputs.service_name }}
      display_name: ${{ steps.config.outputs.display_name }}
      target_host: ${{ steps.config.outputs.target_host }}
      target_ip: ${{ steps.config.outputs.target_ip }}
      ssh_user: ${{ steps.config.outputs.ssh_user }}
      install_path: ${{ steps.config.outputs.install_path }}
      port: ${{ steps.config.outputs.port }}
      subdomain: ${{ steps.config.outputs.subdomain }}
      traefik_enabled: ${{ steps.config.outputs.traefik_enabled }}
      dns_enabled: ${{ steps.config.outputs.dns_enabled }}
      healthcheck_enabled: ${{ steps.config.outputs.healthcheck_enabled }}
      healthcheck_endpoint: ${{ steps.config.outputs.healthcheck_endpoint }}

    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Parse service.yml
        id: config
        run: |
          # Extract configuration from service.yml
          SERVICE_NAME=$(yq '.service.name' service.yml)
          DISPLAY_NAME=$(yq '.service.display_name' service.yml)
          TARGET_HOST=$(yq '.deployment.target_host' service.yml)
          INSTALL_PATH=$(yq '.deployment.install_path // "/opt/" + .service.name' service.yml)
          PORT=$(yq '.deployment.port' service.yml)
          SUBDOMAIN=$(yq '.traefik.subdomain // .service.name' service.yml)
          TRAEFIK_ENABLED=$(yq '.traefik.enabled // true' service.yml)
          DNS_ENABLED=$(yq '.dns.enabled // true' service.yml)
          HEALTHCHECK_ENABLED=$(yq '.deployment.healthcheck.enabled // true' service.yml)
          HEALTHCHECK_ENDPOINT=$(yq '.deployment.healthcheck.endpoint // "/health"' service.yml)

          # Map target host to IP and SSH user
          declare -A HOST_MAP=(
            ["docker-lxc-media"]="192.168.40.11"
            ["docker-lxc-glance"]="192.168.40.12"
            ["docker-vm-core-utilities01"]="192.168.40.13"
            ["docker-lxc-bots"]="192.168.40.14"
            ["traefik-lxc"]="192.168.40.20"
            ["authentik-lxc"]="192.168.40.21"
          )

          declare -A USER_MAP=(
            ["docker-lxc-media"]="hermes-admin"
            ["docker-lxc-glance"]="root"
            ["docker-vm-core-utilities01"]="hermes-admin"
            ["docker-lxc-bots"]="root"
            ["traefik-lxc"]="root"
            ["authentik-lxc"]="root"
          )

          TARGET_IP=${HOST_MAP[$TARGET_HOST]}
          SSH_USER=${USER_MAP[$TARGET_HOST]}

          # Output all values
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "display_name=$DISPLAY_NAME" >> $GITHUB_OUTPUT
          echo "target_host=$TARGET_HOST" >> $GITHUB_OUTPUT
          echo "target_ip=$TARGET_IP" >> $GITHUB_OUTPUT
          echo "ssh_user=$SSH_USER" >> $GITHUB_OUTPUT
          echo "install_path=$INSTALL_PATH" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "subdomain=$SUBDOMAIN" >> $GITHUB_OUTPUT
          echo "traefik_enabled=$TRAEFIK_ENABLED" >> $GITHUB_OUTPUT
          echo "dns_enabled=$DNS_ENABLED" >> $GITHUB_OUTPUT
          echo "healthcheck_enabled=$HEALTHCHECK_ENABLED" >> $GITHUB_OUTPUT
          echo "healthcheck_endpoint=$HEALTHCHECK_ENDPOINT" >> $GITHUB_OUTPUT

          echo "::notice::Deploying $DISPLAY_NAME to $TARGET_HOST ($TARGET_IP)"

  # ===========================================
  # JOB 2: Deploy container to target host
  # ===========================================
  deploy:
    name: Deploy Container
    needs: parse-config
    runs-on: [self-hosted, homelab, docker]
    environment: production

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/homelab_ed25519
          chmod 600 ~/.ssh/homelab_ed25519
          ssh-keyscan -H ${{ needs.parse-config.outputs.target_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Generate .env file from secrets
        run: |
          # Start with base environment variables from service.yml
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import os

          with open('service.yml') as f:
              config = yaml.safe_load(f)

          # Get environment and secrets config
          env_vars = config.get('deployment', {}).get('environment', {})
          secrets = config.get('deployment', {}).get('secrets', [])

          with open('config/.env', 'w') as f:
              # Write static environment variables
              for key, value in env_vars.items():
                  f.write(f"{key}={value}\n")

              # Write secrets (values from GitHub secrets via env vars)
              for secret in secrets:
                  source = secret['source']
                  name = secret['name']
                  value = os.environ.get(source, '')
                  if value:
                      f.write(f"{name}={value}\n")
                  else:
                      print(f"Warning: Secret {source} not found in environment")

              # Add service port
              port = config.get('deployment', {}).get('port', 8080)
              f.write(f"SERVICE_PORT={port}\n")

          print("Generated .env file successfully")
          PYTHON_SCRIPT

      - name: Deploy to target host
        run: |
          TARGET_IP="${{ needs.parse-config.outputs.target_ip }}"
          SSH_USER="${{ needs.parse-config.outputs.ssh_user }}"
          INSTALL_PATH="${{ needs.parse-config.outputs.install_path }}"
          SERVICE_NAME="${{ needs.parse-config.outputs.service_name }}"

          # Determine sudo command
          SUDO=""
          if [ "$SSH_USER" != "root" ]; then
            SUDO="sudo"
          fi

          echo "Deploying $SERVICE_NAME to $SSH_USER@$TARGET_IP:$INSTALL_PATH"

          # Create installation directory
          ssh -i ~/.ssh/homelab_ed25519 ${SSH_USER}@${TARGET_IP} "$SUDO mkdir -p ${INSTALL_PATH}"

          # Backup existing configuration
          ssh -i ~/.ssh/homelab_ed25519 ${SSH_USER}@${TARGET_IP} "
            if [ -f ${INSTALL_PATH}/docker-compose.yml ]; then
              $SUDO cp ${INSTALL_PATH}/docker-compose.yml ${INSTALL_PATH}/docker-compose.yml.bak
            fi
            if [ -f ${INSTALL_PATH}/.env ]; then
              $SUDO cp ${INSTALL_PATH}/.env ${INSTALL_PATH}/.env.bak
            fi
          "

          # Copy new configuration files
          scp -i ~/.ssh/homelab_ed25519 config/docker-compose.yml ${SSH_USER}@${TARGET_IP}:/tmp/${SERVICE_NAME}-compose.yml
          scp -i ~/.ssh/homelab_ed25519 config/.env ${SSH_USER}@${TARGET_IP}:/tmp/${SERVICE_NAME}.env

          # Move files and deploy
          ssh -i ~/.ssh/homelab_ed25519 ${SSH_USER}@${TARGET_IP} << REMOTE_SCRIPT
          $SUDO mv /tmp/${SERVICE_NAME}-compose.yml ${INSTALL_PATH}/docker-compose.yml
          $SUDO mv /tmp/${SERVICE_NAME}.env ${INSTALL_PATH}/.env
          $SUDO chmod 600 ${INSTALL_PATH}/.env
          $SUDO chown root:root ${INSTALL_PATH}/.env

          cd ${INSTALL_PATH}
          echo "Pulling latest images..."
          $SUDO docker compose pull

          echo "Starting containers..."
          $SUDO docker compose up -d --remove-orphans

          echo "Container status:"
          $SUDO docker compose ps
          REMOTE_SCRIPT

      - name: Wait for container to be healthy
        if: needs.parse-config.outputs.healthcheck_enabled == 'true'
        run: |
          TARGET_IP="${{ needs.parse-config.outputs.target_ip }}"
          PORT="${{ needs.parse-config.outputs.port }}"
          ENDPOINT="${{ needs.parse-config.outputs.healthcheck_endpoint }}"

          echo "Waiting for service to be healthy at http://${TARGET_IP}:${PORT}${ENDPOINT}"

          for i in {1..30}; do
            if curl -sf "http://${TARGET_IP}:${PORT}${ENDPOINT}" > /dev/null 2>&1; then
              echo "Service is healthy!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting 5 seconds..."
            sleep 5
          done

          echo "::error::Health check failed after 30 attempts"
          exit 1

  # ===========================================
  # JOB 3: Configure Traefik routing
  # ===========================================
  configure-traefik:
    name: Configure Traefik Route
    needs: [parse-config, deploy]
    runs-on: [self-hosted, homelab, docker]
    if: needs.parse-config.outputs.traefik_enabled == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/homelab_ed25519
          chmod 600 ~/.ssh/homelab_ed25519
          ssh-keyscan -H 192.168.40.20 >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Generate and deploy Traefik configuration
        run: |
          SERVICE_NAME="${{ needs.parse-config.outputs.service_name }}"
          SUBDOMAIN="${{ needs.parse-config.outputs.subdomain }}"
          BACKEND_IP="${{ needs.parse-config.outputs.target_ip }}"
          PORT="${{ needs.parse-config.outputs.port }}"

          # Generate Traefik dynamic config
          cat > /tmp/traefik-${SERVICE_NAME}.yml << EOF
          # Auto-generated by GitHub Actions GitOps
          # Service: ${SERVICE_NAME}
          # Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          http:
            routers:
              ${SERVICE_NAME}:
                rule: "Host(\`${SUBDOMAIN}.${DOMAIN}\`)"
                service: ${SERVICE_NAME}
                entryPoints:
                  - websecure
                tls:
                  certResolver: letsencrypt

            services:
              ${SERVICE_NAME}:
                loadBalancer:
                  servers:
                    - url: "http://${BACKEND_IP}:${PORT}"
          EOF

          # Copy to Traefik
          scp -i ~/.ssh/homelab_ed25519 /tmp/traefik-${SERVICE_NAME}.yml \
            root@192.168.40.20:/opt/traefik/config/dynamic/${SERVICE_NAME}.yml

          echo "::notice::Traefik route configured: https://${SUBDOMAIN}.${DOMAIN}"

  # ===========================================
  # JOB 4: Configure DNS
  # ===========================================
  configure-dns:
    name: Configure DNS Record
    needs: [parse-config, deploy]
    runs-on: [self-hosted, homelab, docker]
    if: needs.parse-config.outputs.dns_enabled == 'true'

    steps:
      - name: Add DNS record via OPNsense API
        run: |
          SUBDOMAIN="${{ needs.parse-config.outputs.subdomain }}"

          # Check if record already exists
          EXISTING=$(curl -sk -u "${{ secrets.OPNSENSE_API_KEY }}:${{ secrets.OPNSENSE_API_SECRET }}" \
            "https://192.168.91.30/api/unbound/settings/searchHostOverride" \
            -d "searchPhrase=${SUBDOMAIN}" | jq -r '.rows | length')

          if [ "$EXISTING" -gt "0" ]; then
            echo "DNS record for ${SUBDOMAIN} already exists, skipping..."
            exit 0
          fi

          # Add DNS record pointing to Traefik
          curl -sk -X POST \
            -u "${{ secrets.OPNSENSE_API_KEY }}:${{ secrets.OPNSENSE_API_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"host\": {
                \"enabled\": \"1\",
                \"hostname\": \"${SUBDOMAIN}\",
                \"domain\": \"${DOMAIN}\",
                \"rr\": \"A\",
                \"server\": \"192.168.40.20\",
                \"description\": \"Auto-added via GitHub Actions GitOps\"
              }
            }" \
            "https://192.168.91.30/api/unbound/settings/addHostOverride"

          # Apply DNS configuration
          curl -sk -X POST \
            -u "${{ secrets.OPNSENSE_API_KEY }}:${{ secrets.OPNSENSE_API_SECRET }}" \
            -H "Content-Type: application/json" \
            -d "{}" \
            "https://192.168.91.30/api/unbound/service/reconfigure"

          echo "::notice::DNS record added: ${SUBDOMAIN}.${DOMAIN} -> 192.168.40.20"

  # ===========================================
  # JOB 5: Send notifications
  # ===========================================
  notify:
    name: Send Discord Notification
    needs: [parse-config, deploy, configure-traefik, configure-dns]
    runs-on: [self-hosted, homelab, docker]
    if: always()

    steps:
      - name: Send success notification
        if: needs.deploy.result == 'success'
        run: |
          DISPLAY_NAME="${{ needs.parse-config.outputs.display_name }}"
          SUBDOMAIN="${{ needs.parse-config.outputs.subdomain }}"
          URL="https://${SUBDOMAIN}.${DOMAIN}"

          curl -sS -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Homelab GitOps\",
              \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
              \"embeds\": [{
                \"title\": \":white_check_mark: Deployed: ${DISPLAY_NAME}\",
                \"description\": \"Service deployed successfully via GitHub Actions\",
                \"color\": 3066993,
                \"fields\": [
                  {\"name\": \":globe_with_meridians: URL\", \"value\": \"[${URL}](${URL})\", \"inline\": true},
                  {\"name\": \":link: Workflow\", \"value\": \"[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true},
                  {\"name\": \":bust_in_silhouette: Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"GitHub Actions GitOps\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Send failure notification
        if: needs.deploy.result == 'failure'
        run: |
          DISPLAY_NAME="${{ needs.parse-config.outputs.display_name }}"

          curl -sS -H "Content-Type: application/json" \
            -d "{
              \"username\": \"Homelab GitOps\",
              \"avatar_url\": \"https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png\",
              \"embeds\": [{
                \"title\": \":x: Deployment Failed: ${DISPLAY_NAME}\",
                \"description\": \"Check workflow logs for details\",
                \"color\": 15158332,
                \"fields\": [
                  {\"name\": \":link: Workflow Logs\", \"value\": \"[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": true},
                  {\"name\": \":bust_in_silhouette: Triggered by\", \"value\": \"${{ github.actor }}\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"GitHub Actions GitOps\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"
