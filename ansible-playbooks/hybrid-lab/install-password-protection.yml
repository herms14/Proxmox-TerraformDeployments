# =============================================================================
# Install Azure AD Password Protection on AADPP01 and AADPP02
# =============================================================================
# This playbook installs Azure AD Password Protection Proxy and DC Agent
#
# Components:
#   - AADPP01/AADPP02: Password Protection Proxy servers
#   - DC01/DC02: DC Agent (installed on domain controllers)
#
# Prerequisites:
#   - Servers must be domain joined
#   - Azure AD Global Admin or Security Admin credentials
#   - Domain Controllers must be Windows Server 2012 R2 or later
#
# Usage:
#   ansible-playbook -i inventory.yml install-password-protection.yml
# =============================================================================

---
# First, install the Proxy component on AADPP servers
- name: Install Password Protection Proxy
  hosts: password_protection
  gather_facts: yes
  vars:
    domain_name: hrmsmrflrii.xyz
    proxy_download_url: "https://download.microsoft.com/download/d/d/6/dd69b5a3-6b0d-4cf8-8a5e-b7cd69e7a358/AzureADPasswordProtectionProxySetup.exe"
    temp_download_path: "C:\\Temp"

  tasks:
    - name: Create temp directory
      win_file:
        path: "{{ temp_download_path }}"
        state: directory

    - name: Check if Password Protection Proxy is installed
      win_shell: |
        $service = Get-Service -Name 'AzureADPasswordProtectionProxy' -ErrorAction SilentlyContinue
        if ($service) {
          Write-Output "installed"
        } else {
          Write-Output "not_installed"
        }
      register: proxy_check
      changed_when: false

    - name: Download Password Protection Proxy installer
      win_get_url:
        url: "{{ proxy_download_url }}"
        dest: "{{ temp_download_path }}\\AzureADPasswordProtectionProxySetup.exe"
      when: "'not_installed' in proxy_check.stdout"

    - name: Install .NET Framework 4.7.2 or later
      win_feature:
        name: NET-Framework-45-Features
        state: present
        include_sub_features: yes
      register: dotnet_install

    - name: Reboot if .NET installation requires
      win_reboot:
        reboot_timeout: 600
      when: dotnet_install.reboot_required

    - name: Install Password Protection Proxy
      win_shell: |
        $installer = "{{ temp_download_path }}\\AzureADPasswordProtectionProxySetup.exe"
        $process = Start-Process -FilePath $installer -ArgumentList "/quiet /norestart" -Wait -PassThru -NoNewWindow
        if ($process.ExitCode -eq 0 -or $process.ExitCode -eq 3010) {
          Write-Output "Installation successful"
          exit 0
        } else {
          Write-Error "Installation failed with exit code: $($process.ExitCode)"
          exit $process.ExitCode
        }
      when: "'not_installed' in proxy_check.stdout"
      register: proxy_install
      async: 600
      poll: 30

    - name: Reboot after proxy installation
      win_reboot:
        reboot_timeout: 600
      when: proxy_install is changed

    - name: Wait for Password Protection Proxy service
      win_shell: |
        $timeout = 120
        $start = Get-Date
        while ((Get-Date) -lt $start.AddSeconds($timeout)) {
          $service = Get-Service -Name 'AzureADPasswordProtectionProxy' -ErrorAction SilentlyContinue
          if ($service) {
            Write-Output "Service found: $($service.Status)"
            exit 0
          }
          Start-Sleep -Seconds 5
        }
        Write-Output "Service not found"
        exit 1
      register: proxy_service_check

    - name: Start Password Protection Proxy service
      win_service:
        name: AzureADPasswordProtectionProxy
        state: started
        start_mode: auto

    - name: Configure Windows Firewall for Proxy
      win_firewall_rule:
        name: "{{ item.name }}"
        localport: "{{ item.port }}"
        action: allow
        direction: "{{ item.direction }}"
        protocol: tcp
        state: present
        enabled: yes
      loop:
        - { name: "Password Protection Proxy - HTTPS Out", port: 443, direction: out }
        - { name: "Password Protection Proxy - RPC", port: 135, direction: in }

    - name: Display proxy installation status
      debug:
        msg: |
          Password Protection Proxy Installation Complete
          ================================================
          Server: {{ inventory_hostname }}
          Service Status: {{ proxy_service_check.stdout }}

          NEXT STEPS (Manual Registration Required):
          1. Open PowerShell as Administrator on {{ inventory_hostname }}
          2. Import module: Import-Module AzureADPasswordProtection
          3. Register proxy: Register-AzureADPasswordProtectionProxy -AccountUpn admin@yourtenant.onmicrosoft.com
          4. Register forest: Register-AzureADPasswordProtectionForest -AccountUpn admin@yourtenant.onmicrosoft.com

# Second, install the DC Agent on Domain Controllers
- name: Install Password Protection DC Agent
  hosts: domain_controllers
  gather_facts: yes
  vars:
    domain_name: hrmsmrflrii.xyz
    dcagent_download_url: "https://download.microsoft.com/download/d/d/6/dd69b5a3-6b0d-4cf8-8a5e-b7cd69e7a358/AzureADPasswordProtectionDCAgentSetup.msi"
    temp_download_path: "C:\\Temp"

  tasks:
    - name: Create temp directory
      win_file:
        path: "{{ temp_download_path }}"
        state: directory

    - name: Check if DC Agent is installed
      win_shell: |
        $service = Get-Service -Name 'AzureADPasswordProtectionDCAgent' -ErrorAction SilentlyContinue
        if ($service) {
          Write-Output "installed"
        } else {
          Write-Output "not_installed"
        }
      register: dcagent_check
      changed_when: false

    - name: Download DC Agent installer
      win_get_url:
        url: "{{ dcagent_download_url }}"
        dest: "{{ temp_download_path }}\\AzureADPasswordProtectionDCAgentSetup.msi"
      when: "'not_installed' in dcagent_check.stdout"

    - name: Install DC Agent
      win_package:
        path: "{{ temp_download_path }}\\AzureADPasswordProtectionDCAgentSetup.msi"
        state: present
        arguments: /quiet /norestart
      when: "'not_installed' in dcagent_check.stdout"
      register: dcagent_install

    - name: Reboot after DC Agent installation (required)
      win_reboot:
        reboot_timeout: 900
        post_reboot_delay: 60
      when: dcagent_install is changed

    - name: Verify DC Agent service is running
      win_service:
        name: AzureADPasswordProtectionDCAgent
        state: started
        start_mode: auto

    - name: Verify password filter is registered
      win_shell: |
        $filters = (Get-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa' -Name 'Notification Packages').{Notification Packages}
        if ($filters -contains 'AzureADPasswordProtectionPasswordFilter') {
          Write-Output "Password filter registered"
        } else {
          Write-Output "Password filter NOT registered"
        }
      register: filter_check

    - name: Display DC Agent installation status
      debug:
        msg: |
          Password Protection DC Agent Installation Complete
          ===================================================
          Server: {{ inventory_hostname }}
          Password Filter: {{ filter_check.stdout }}

# Final verification play
- name: Verify Password Protection Deployment
  hosts: password_protection:domain_controllers
  gather_facts: no
  tasks:
    - name: Create deployment summary
      win_copy:
        content: |
          Azure AD Password Protection Deployment Summary
          ================================================

          Deployment Date: {{ ansible_date_time.iso8601 | default('N/A') }}
          Server: {{ inventory_hostname }}
          Role: {{ 'Proxy' if 'password_protection' in group_names else 'DC Agent' }}

          Post-Installation Checklist:
          ============================

          For Proxy Servers (AADPP01, AADPP02):
          [ ] Register proxy with Azure AD
              Import-Module AzureADPasswordProtection
              Register-AzureADPasswordProtectionProxy -AccountUpn admin@tenant.onmicrosoft.com

          [ ] Register forest with Azure AD (run once from any proxy)
              Register-AzureADPasswordProtectionForest -AccountUpn admin@tenant.onmicrosoft.com

          For Domain Controllers (DC01, DC02):
          [ ] Verify service is running
              Get-Service AzureADPasswordProtectionDCAgent

          [ ] Verify password filter
              (Get-ItemProperty 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa').'Notification Packages'

          Verification Commands:
          =====================
          # Check proxy status
          Get-AzureADPasswordProtectionProxy

          # Check DC agent status
          Get-AzureADPasswordProtectionDCAgent

          # Check forest registration
          Get-AzureADPasswordProtectionSummaryReport

          Azure Portal:
          - Password Protection settings: https://portal.azure.com/#blade/Microsoft_AAD_IAM/AuthenticationMethodsMenuBlade/PasswordProtection
        dest: C:\PasswordProtection_Deployment_Summary.txt
      ignore_errors: yes
